\chapter{Two Dimensional Deterministic Case}\label{chap:two-d-deterministic}

In two dimensions, with deterministic coefficients Laplace's equation takes the
following form:

\begin{equation}\label{eq:two-d-deterministic}
\begin{aligned}
    -\nabla\cdot(a\nabla u(\v{x})) + \v{b} \cdot \nabla u(\v{x}) + c u(\v{x}) &= f(\v{x})
                               &\text{ in } D = [0,1] \times [0,1] \\
    u(\v{x}) &= g(\v{x}) &\text{ on } \partial D = \Gamma
\end{aligned}
\end{equation}

where $a, c \in \mathbb{R}$, $\v{b} \in \mathbb{R}^2$ and $f, g \in L^2(D)$ are
given.

\section{Weak Formulation}

\todo[inline]{Give proper definitions of the trial and test spaces}

As with the one dimensional case, the first step in implementing the finite
element method for this problem is to obtain the weak formulation of the above
equation. Which involves multiplying through by $v \in W$ and integrating over
the domain:

\begin{equation}
    -\int_{\Omega}{v(\nabla\cdot(a\nabla{u}))}\,d\Omega +
    -\int_{\Omega}\v{b}\cdot v\nabla{u}\,d\Omega +
    c\int_{\Omega}uv\,d\Omega = \int_{\Omega}fv\,d\Omega
\end{equation}

Applying Green's first integral identity to the first term we get:

\begin{equation}
    \int_{\Omega}v(\nabla\cdot(a\nabla u))\, d\Omega =
    -a\int_{\Gamma}\underbrace{v\frac{\partial{u}}{\partial{n}}}_{ =0} \,d\Gamma
    + a\int_{\Omega}\nabla{v}\cdot\nabla{u}\,d\Omega
\end{equation}

Where the underbraced integrand is zero on the boundary as by definition $v$ is
zero there hence the whole term vanishes. Thus we are left with the continuous
weak form of the problem:

\begin{equation}\label{eq:wk-twod-deterministic}
    a\int_{\Omega}\nabla{v}\cdot\nabla{u}\,d\Omega +
    \int_{\Omega}\v{b}\cdot v\nabla{u}\,d\Omega + c\int_{\Omega}uv\,d\Omega =
    \int_{\Omega}fv\,d\Omega
\end{equation}

Hence the weak solution is to find a $u \in V$ such that the above holds
$\forall v \in W$

\section{Discrete Formulation}

\todo[inline]{This probably needs some work, especially when it comes to indices etc.}

Moving from the one dimensional case to two dimensions suddenly adds a number
of considerations since, unlike the one dimensional interval any two
dimensional domain can come in a wide array of shapes. Therefore the method of
discretisation must be chosen with the shape of the domain in mind, as what may
be suitable for one domain would fail to capture certain features of
another.However as the focus of this project is not on finding a discretisation
for arbitrary domains, we have chosen the unit square since a simple uniform
triangulation will be sufficient.

Given a parameter $N \in \mathbb{N}$ we start with square grid with spacing $h
= 1/N$ then at each of the $(N+1)^2$ intersections we place a node $x_i$, $i
\in \{1,\ldots,(N+1)^2\}$. Then we divide each grid square into 2 triangles by
splitting them down the diagonal, dividing the domain into triangular elements
$T_k$ which we can then use to define the discretisation:

\[
    \mathcal{T}_h = \bigcup_{k=1}^{2N^2} T_k
\]

Please see Figure \ref{fig:two-d-discretisation} for an example of such a
discretisation.

\begin{figure}
\centering
\input{figures/twod-discretisation.tikz}
\caption{Example triangulation of $\Omega$ with $N = 4$}
\label{fig:two-d-discretisation}
\end{figure}

Using this triangulation we can now define suitable finite dimensional subspaces
of our test and trial spaces $V^h \subset V$, $W^h \subset W$:

\begin{align*}
    V^h = \{v \in V: &v \text{ is linear on } T_k,\ k \in \{1,\ldots,2N^2\}, \\
                     &v \text{ is continuous on } \Omega\}
\end{align*}

Then by choosing appropriate basis functions $\phi_i$ for the above subspaces
we will be able to approximate the solution as follows:

\begin{equation}
    u^h(\v{x}) = \sum_{j=1}^{(N+1)^2}u_j\phi_j(\v{x})
\end{equation}

where $u_j$ will be the approximate value of the solution at the node $x_j$.
Similarly we can approximate $f(\v{x})$:

\begin{equation}
    f(x) \approx \sum_{j=1}^{(N+1)^2}f_j\phi_j(\v{x})
\end{equation}

where $f_j = f(\v{x_j})$

\todo[inline]{Give details on errors, convergence etc!}

As in the one dimensional case, an appropriate basis would be the `hat
functions' which we can define in terms of a reference function $\Phi(\v{x})$
defined with respect to an example domain around $(0,0)$.  Consider as in
Figure \ref{fig:reference-function-domain} the domain where the function has
support, then we can write $\Phi(\v{x})$ as follows:

\begin{equation}\label{eq:two-d-ref-basis-fn}
    \Phi(\v{x}) = \left\{\begin{array}{c c}
                    1 - x - y, & \text{ in } T_1 \\
                    1 - x,       & \text{ in } T_2 \\
                    1 + y,       & \text{ in } T_3 \\
                    1 + x + y,   & \text{ in } T_4 \\
                    1 + x,       & \text{ in } T_5 \\
                    1 - y,       & \text{ in } T_6 \\
                    0,           & \text{ otherwise}
                  \end{array}\right.
\end{equation}

where $\v{x} = (x, y)$. Then we can write each basis function $\phi_i$ in our
discretised domain as $\phi_i(\v{x}) = \Phi(\v{x} - \v{x_i})$

\begin{figure}
\centering
\input{figures/twod-reference-basis-domain.tikz}
\caption{The domain of the reference function $\Phi(\v{x})$}
\label{fig:reference-function-domain}
\end{figure}

Since the weak formulation \myref{eq:wk-twod-deterministic} has to hold
forall $v \in V$, in particular it has to hold for the basis functions
$\phi_i(\v{x})$, $i \in \{1,\ldots,(N + 1)^2\}$ so by taking
$v = \sum_{i = 1}^{(N+1)^2}\phi_i(\v{x})$ and substituting our expansions
for $u$ and $f$ we get:

\begin{align}
\begin{split}
    &a\int_{\Omega}\nabla\left(\sum_{i = 1}^{(N+1)^2}\phi_i(\v{x})\right) \cdot
                  \nabla\left(\sum_{j = 1}^{(N+1)^2}u_j\phi_j(\v{x})\right)\, d\Omega
    +\int_{\Omega}\v{b}\cdot\left(\sum_{i = 1}^{(N+1)^2}\phi_i(\v{x})\right) \cdot
                  \nabla\left(\sum_{j = 1}^{(N+1)^2}u_j\phi_j(\v{x})\right)\, d\Omega \\
    &+c\int_{\Omega}\left(\sum_{i = 1}^{(N + 1)^2}\phi_i(\v{x})\right)
                    \left(\sum_{j = 1}^{(N + 1)^2}u_j\phi_j(\v{x})\right)\, d\Omega =
    \int_{\Omega}\left(\sum_{j = 1}^{(N + 1)^2}f_j\phi_j(\v{x})\right)
                 \left(\sum_{i = 1}^{(N + 1)^2}\phi_i(\v{x})\right)\, d\Omega
\end{split}
\end{align}

Then by the linearity of the integral and the gradient operator this can be
written as:

\begin{align}\label{eq:twod-deterministic-discrete}
  \begin{split}
    \sum_{i=1}^{(N+1)^2}\sum_{j=1}^{(N+1)^2}
      \underbrace{\left(
         a\int_{\Omega}\nabla\phi_i(\v{x})\cdot\nabla\phi_j(\v{x})\, d\Omega
         + \v{b}\cdot\int_{\Omega}\phi_i(\v{x})\cdot\nabla\phi_j(\v{x})\, d\Omega
         +c\int_{\Omega}\phi_i(\v{x})\phi_j(\v{x})\, d\Omega
      \right)}_{:= A_{i,j}}u_j = \\
    \sum_{i=1}^{(N + 1)^2}\sum_{j=1}^{(N + 1)^2}
      \underbrace{\int_{\Omega}\phi_i(\v{x})\phi_j(\v{x})}_{:= M_{i,j}}
  \end{split}
\end{align}

Which reduces the weak formulation \myref{eq:wk-twod-deterministic} to a linear
system $Au^h = Mf$ where as in the one dimensional case $A$ is known as
the stiffness matrix and $M$ is known as the mass matrix. But due to the Dirichlet
condition in \myref{eq:two-d-deterministic} we already know the values of $u_j$
along the boundary so the above reduces to:

\begin{equation}
    \sum_{i = 1}^{(N-1)^2}\sum_{j=1}^{(N-1)^2}A_{i,j}u_j =
    \sum_{i=1}^{(N-1)^2}\sum_{j=0}^{(N+1)^2}M_{i,j}f_j
\end{equation}

Solving this system will give us an approximation to the solution for
\myref{eq:two-d-deterministic}

\section{Constructing the Global System}

The last thing we need to do in order to implement the finite element method
for this problem is to determine the entries of the global mass and stiffness
matrices $M$ and $A$ respectively. Since we have discretised our domain into
many triangular elements, we can consider the contribution from in each element
in turn and combine them into the global system.

Consider a triangular element $T$, comprised of the nodes $\v{k_1} = (0,0)$,
$\v{k_2} = (0,1)$, and $\v{k_3} = (1,0)$ with corresponding global basis functions
$\phi_{k_1}, \phi_{k_2}, \phi_{k_3}$. Now if we compare Figure
\ref{fig:twod-local-basis}, with Figure \ref{fig:reference-function-domain}
we see that the dashed lines denote the support of each of the basis functions
and the solid lines denote the subset of the domain which contains the triangular
element $T$.

Comparing further the two Figures we see that the Triangular element $T$
corresponds to $T_1$ in the reference function for the basis function $\phi_{k1}$
and $T_5$ for $\phi_{k_2}$ and $T_3$ for $\phi_{k_3}$. This means locally in the
element $T_k$ we can define the following local basis functions:

\begin{align}\label{eq:twod-local-basis}
    \begin{split}
        \psi_1(x, y) = \Phi(\v{x} - \v{k_1})|_{T_1} &= 1 - x - y \\
        \psi_2(x, y) = \Phi(\v{x} - \v{k_2})|_{T_5} &= x \\
        \psi_3(x, y) = \Phi(\v{x} - \v{k_3})|_{T_3} &= y
    \end{split}
\end{align}

\begin{figure}
\centering
\begin{subfigure}[b]{0.30\textwidth}
    \centering
    \resizebox{\linewidth}{!}{\input{figures/twod-local-basis-k1.tikz}}
\end{subfigure}
\begin{subfigure}[b]{0.30\textwidth}
    \centering
    \resizebox{\linewidth}{!}{\input{figures/twod-local-basis-k2.tikz}}
\end{subfigure}
\begin{subfigure}[b]{0.30\textwidth}
    \centering
    \resizebox{\linewidth}{!}{\input{figures/twod-local-basis-k3.tikz}}
\end{subfigure}
\caption{Local contributions of the global basis functions
         $\phi_{k_1}, \phi_{k_2}, \phi_{k_3}$.}
\label{fig:twod-local-basis}
\end{figure}

This means that any $v \in V^h$ can locally in $T$ be written as:
\[
    v(\v{x}) = v(\v{k_1})\psi_1(\v{x}) + v(\v{k_2})\psi_2(\v{x}) + v(\v{k_3})\psi_3(\v{x})
\]

Furthermore, since we are using a uniform triangulation all of our triangles
are similar to this triangular element $T$ which we will now call the reference
triangle. Hence by introducing the mapping:

\begin{align*}
 \begin{array}{c c}
    \zeta = \frac{x}{h} & \eta = \frac{y}{h}
 \end{array}
\end{align*}

we can map any triangular element $T_k$ in our discretisation onto the reference
triangle $T$ where $h$ represents the length of the sides of the triangular
element $T_k$. Therefore by a change of variables we can for each element $T_k$ in the discretisation of the
domain locally write \myref{eq:twod-deterministic-discrete} as an integration around the reference
triangle $T$ as follows:

\begin{align}\label{eq:twod-deterministic-discrete-local}
    \begin{split}
    \sum_{r=1}^3\sum_{s=1}^3\underbrace{
      \left(
        ah^2\int_{T}\nabla\psi_r(\zeta, \eta)\cdot\nabla\psi_s(\zeta, \eta)\ d\zeta d\eta
        + h^2\v{b} \cdot \int_{T}\psi_r(\zeta,\eta)\cdot\nabla\psi_s(\zeta,\eta)\ d\zeta d\eta
        + ch^2\int_{T}\psi_r(\zeta,\eta)\psi_s(\zeta,\eta)\ d\zeta d\eta
      \right)}_{A^{(k)}_{r,s}}u_s = \\
    \sum_{r=1}^3\sum_{s=1}^3\underbrace{\left(
        h^2\int_{T_k}\psi_r(\zeta,\eta)\psi_s(\zeta,\eta)\ d\zeta d\eta
    \right)}_{M^{(k)}_{r,s}}f_s
    \end{split}
\end{align}

Where $A^{(k)}$ and $M^{(k)}$ are the $3 \times 3$ local stiffness and mass
matrices respectively. Since evaluating their entries will involve derivatives
of the local basis functions we shall compute these now:

\begin{align}
    \begin{split}
        \nabla\psi_1(x, y) &= \left(\begin{array}{c} -1 \\ -1 \end{array}\right) \\
        \nabla\psi_2(x, y) &= \left(\begin{array}{c} 1 \\ 0 \end{array}\right) \\
        \nabla\psi_3(x, y) &= \left(\begin{array}{c} 0 \\ 1 \end{array}\right)
    \end{split}
\end{align}

\subsection{The Local Stiffness Matrix}

Similar to the one dimensional case, we now have an expression for the entries
of the local stiffness matrix, in terms of a number of integrals
\myref{eq:twod-deterministic-discrete-local} so we will only include a few
example cases and then present the results.

If we first consider the integral which gives the contribution from the
Laplacian:

\begin{equation*}
    ah^2\int_T\nabla\psi_r(\zeta,\eta)\cdot\nabla\psi_s(\zeta,\eta)\ d\zeta d\eta =
    ah^2\int_T\psi_{r\zeta}'\psi_{s\zeta}' + \psi_{r\eta}'\psi_{s\eta}'\ d\zeta d\eta
\end{equation*}

and if we take $r = 1$ and $s = 1$ then we get:

\begin{align*}
    ah^2\int_T(\psi_{i\zeta}')^2 + (\psi_{1\eta}')^2\ d\zeta d\eta
    &= ah^2\int_0^1\int_0^{1 - \eta}\frac{1}{h^2}((-1)^2 + (-1)^2)\ d\zeta d\eta \\
    &= 2a\int_0^1\left[\zeta\right]_0^{1 - \eta} \\
    &= 2a\left[\eta - \frac{\eta^2}{2}\right]_0^1 \\
    &= 2a\frac{1}{2} \\
    &= a
\end{align*}

Similarly let's consider the second integral corresponding to the gradient term,
in the case when $r = 1, s = 3$:

\begin{align*}
    h^2\int_T\psi_1(\zeta,\eta)\v{b} \cdot \nabla\psi_3(\zeta,\eta)\ d\zeta d\eta
     &= h^2\int_0^1\int_0^{1-\eta}\frac{1}{h}(1 - \zeta - \eta)
           \left(\begin{array}{c} b_1 \\b_2 \end{array}\right) \cdot
           \left(\begin{array}{c} 0 \\ 1 \end{array}\right)\ d\zeta d\eta \\
     &= hb_2\int_0^1\int_0^{1-\eta} 1 - \zeta - \eta \ d\zeta d\eta \\
     &= hb_2\int_0^1\left[\zeta - \frac{\zeta^2}{2} - \eta\zeta \right]_0^{1-\eta}\ d\eta \\
     &= hb_2\int_0^1(1 -\eta) - \eta(1-\eta) - \frac{(1 - \eta)^2}{2}\ d\eta \\
     &= hb_2\int_0^1\frac{1}{2} -\eta +\frac{\eta^2}{2}\ d\eta \\
     &= \left[\frac{\eta}{2} - \frac{\eta^2}{2} + \frac{\eta^3}{6}\right]_0^1 \\
     &= \frac{hb_2}{6}
\end{align*}

Now considering third integral, in the case where $r = 3, s = 2$:

\begin{align*}
    ch^2\int_T\psi_3(\zeta,\eta)\psi_2(\zeta,\eta)\ d\zeta d\eta
    &= ch^2\int_0^1\int_0^{1-\eta}\zeta\eta\ d\zeta d\eta \\
    &= ch^2\int_0^1\left[\frac{\zeta^2\eta}{2}\right]_0^{1-\eta}\ d\eta \\
    &= ch^2\int_0^1\frac{(1-\eta)^2\eta}{2}\ d\eta \\
    &= \frac{ch^2}{2}\left[\frac{\eta^2}{2} - \frac{2\eta^3}{3} - \frac{\eta^4}{4}\right]_0^1 \\
    &= \frac{ch^2}{24}
\end{align*}

Following a similar process for the rest of the entries gives us the following
form for the local stiffness matrix:

\begin{equation}\label{eq:twod-local-stiffness}
 A^{(k)} =
    \frac{a}{2}\left(\begin{array}{c c c}
         2 & -1 & -1 \\
        -1 &  1 &  0 \\
        -1 &  0 &  1
    \end{array}\right)
    + \frac{h}{12} \left(\begin{array}{c c c}
        -(b_1 + b_2) & 2b_1 & 2b_2 \\
        -(b_1 + b_2) & 2b_1  & 2b_2 \\
        -(b_1 + b_2) & 2b_1  & 2b_2
    \end{array}\right)
    + \frac{ch^2}{24}\left(\begin{array}{c c c}
         2 &  1 &  1 \\
         1 &  2 &  1 \\
         1 &  1 &  2
      \end{array}\right)
\end{equation}

where $a, c \in \mathbb{R}$ and $\v{b} = (b_1, b_2) \in \mathbb{R}^2$
correspond to the parameters which define the original equation
\myref{eq:two-d-deterministic} we considered.

\subsection{The Local Mass Matrix}

Following the same procedure, we can also compute the entries of the local mass
matrix as defined in \myref{eq:twod-deterministic-discrete-local}, in fact the
entries of the mass matrix are the same as those in those in the third term of
the local stiffness matrix so we have already seen the case $r = 3, s = 2$ and
by the fact that the matrix is symmetric the case $r = 2, s = 3$. So let's
consider the case where $r = 1, s = 2$:

\begin{align*}
    h^2\int_T\psi_1(\zeta,\eta)\psi_2(\zeta,\eta)\ d\zeta d\eta
    &=  h^2\int_0^1\int_0^{1-\eta}(1 - \zeta -\eta)\zeta\ d\zeta d\eta \\
    &= h^2\int_0^1\left[\frac{\zeta^2}{2} -\frac{\zeta^3}{3}
                        -\frac{\zeta^2\eta}{2}\right]_0^{1-\eta}\  d\eta \\
    &= h^2\int_0^1\frac{(1-\eta)^2}{2} - \frac{(1-\eta)^3}{3}- \frac{(1-\eta)^2\eta}{2}\ d\eta \\
    &= \frac{h^2}{6}\int_0^1(1- \eta)^3\ d\eta \\
    &= \frac{h^2}{6}\left[\eta -\frac{3\eta}{2} + \eta^3 - \frac{\eta^4}{4}\right]_0^1 \\
    &= \frac{h^2}{24}
\end{align*}

and by symmetry this is the same as the case $r = 2, s = 1$. Finally we can consider the case
$r = 1, s = 3$

\begin{align*}
    h_2\int_T\psi_1(\zeta, \eta)\psi_3(\zeta, \eta)\ d\zeta d\eta
    &= h^2\int_0^1\int_0^{1-\eta}(1 - \zeta - \eta)\eta\ d\zeta d\eta \\
    &= h^2\int_0^1\left[\zeta\eta - \frac{\zeta^2\eta}{2} - \eta^2\zeta\right]_0^{1-\eta}\ d\eta \\
    &= h^2\int_0^1(1-\eta)\eta - \frac{(1 - \eta)^2\eta}{2} - \eta^2(1 - \eta)\ d\eta \\
    &= \frac{h^2}{2}\int_0^1(1 - \eta)^2\eta \ d\eta \\
    &= \frac{h^2}{2}\left[\frac{\eta^2}{2} - \frac{2\eta^3}{2} + \frac{\eta^4}{4}\right]_0^1 \\
    &= \frac{h^2}{24}
\end{align*}

which again by symmetry will also give us the case where $r = 3, s = 1$. If we
follow the same procedure for the remaining diagonal elements we obtain the
following form for the local mass matrix:

\begin{equation}\label{eq:twod-local-mass}
    M^{(k)} =
    \frac{h^2}{24}\left(\begin{array}{c c c}
         2 &  1 &  1 \\
         1 &  2 &  1 \\
         1 &  1 &  2
      \end{array}\right)
\end{equation}

\subsection{Assembling the Global Stiffness Matrix}

Now that we know the form of local stiffness matrix
\myref{eq:twod-local-stiffness} we can start to assemble the global stiffness
matrix. As in the one dimensional case, we need to take into account the
contributions each of the elements surrounding a node make to its value. So we
need to find a way write \myref{eq:twod-deterministic-discrete} in terms of
\myref{eq:twod-deterministic-discrete-local}.

Let's first consider the diagonal entries of the global stiffness matrix
$A_{k,k}$ which are given by:

\begin{align*}
A_{k,k} =
    a\int_{\Omega}\nabla\phi_k(\v{x}) \cdot \nabla\phi_k(\v{x})\ d\Omega
    + \int_{\Omega}\phi_k(\v{x})\v{b} \cdot \nabla\phi_k(\v{x})\ d\Omega
    + c\int_{\Omega}(\phi_k(\v{x}))^2\ d\Omega
\end{align*}

Now recall how we defined the global basis functions in terms of a reference
function $\Phi(\v{x})$, this allows us to break up the integral over the entire
domain $\Omega$ into an integral over the 6 triangular elements which make up
the domain where the reference function has support.
